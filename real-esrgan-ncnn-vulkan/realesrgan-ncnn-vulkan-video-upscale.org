#+STARTUP: content
* realesrgan-ncnn-vulkan video upscale
** ffmpeg extract frames

#+begin_src sh
mkdir -p frames
#+end_src

#+begin_src sh
ffmpeg -i input.mp4 -qscale:v 1 -qmin 1 -vsync 0 frames/frame_%08d.png
#+end_src

** realesrgan-ncnn-vulkan upscale

#+begin_src sh
mkdir -p upscaled_frames
#+end_src

#+begin_src sh
realesrgan-ncnn-vulkan -i frames -o upscaled_frames -n realesrgan-x4plus -s 4 -f png
#+end_src

** ffmpeg create video from upscaled frames

#+begin_src sh
ffmpeg -framerate $(ffprobe -v error -select_streams v:0 -show_entries stream=r_frame_rate -of default=noprint_wrappers=1:nokey=1 input.mp4) \
-i upscaled_frames/frame_%08d.png \
-i input.mp4 \
-map 0:v:0 -map '1:a?' \
-c:v hevc_nvenc \
-tune hq \
-preset p7 \
-rc vbr \
-multipass fullres \
-cq 20 \
-b:v 0 \
-rc-lookahead 32 \
-spatial-aq 1 \
-c:a copy \
-pix_fmt yuv420p \
-movflags +faststart \
output_upscaled.mp4
#+end_src

** compare videos

#+begin_src sh
ffmpeg \
-i input.mp4 \
-i output_upscaled.mp4 \
-filter_complex \
"[0:v]scale=iw*4:ih*4:flags=lanczos[left]; \
 [left][1:v]hstack=inputs=2[v]" \
-map "[v]" \
-map 0:a \
-c:v hevc_nvenc \
-cq 20 \
-preset p4 \
-c:a copy \
-pix_fmt yuv420p \
-movflags +faststart \
comparison.mp4
#+end_src

** compare 4k videos side by side

#+begin_src sh
ffmpeg \
-i input-libplacebo.mp4 \
-i input-realesrgan.mp4 \
-filter_complex \
"[0:v]scale=1920:1080:flags=lanczos[left]; \
 [1:v]scale=1920:1080:flags=lanczos[right]; \
 [left][right]hstack=inputs=2[v]" \
-map "[v]" \
-map 0:a \
-c:v hevc_nvenc \
-cq 20 \
-preset p4 \
-c:a copy \
-pix_fmt yuv420p \
-movflags +faststart \
comparison.mp4
#+end_src
