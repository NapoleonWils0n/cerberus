#+STARTUP: content
* gptel
** resources

[[https://github.com/karthink/gptel]]

** init.el

#+begin_src sh
vi ~/.config/emacs/init.el
#+end_src

#+begin_src elisp
;; ----------------------------------------------------------------------------------
;; auth-source
;; ----------------------------------------------------------------------------------

(require 'auth-source)
(add-to-list 'auth-sources (expand-file-name ".authinfo" user-emacs-directory))


;; ----------------------------------------------------------------------------------
;; gptel
;; ----------------------------------------------------------------------------------

(use-package gptel
  :init
  ;; Enable tool use
  (setq gptel-use-tools t)
  (setq gptel-default-mode 'org-mode
        gptel-post-response-functions #'gptel-end-of-response
        gptel-expert-commands t)
  (require 'gptel-integrations) 
  :config
  (setq gptel-model 'mistral:7b)
  (setq gptel-model 'llama3.1:8b)
  (setq gptel-model 'gemma3:4b)
  (setq gptel-model 'deepseek-r1:8b)
  (setq gptel-model 'granite4:tiny-h)
  (setq gptel-backend (gptel-make-ollama "Ollama"
                        :host "localhost:11434"
                        :stream t
                        :models '(gemma3:4b
                                  mistral:7b
                                  llama3.1:8b
                                  granite4:tiny-h
                                  deepseek-r1:8b)))

  (setq gptel-model 'gemini-2.5-flash
        gptel-backend (gptel-make-gemini "Gemini"
                                         :key (gptel-api-key-from-auth-source "generativelanguage.googleapis.com")
                                         :stream t))
  

;; ----------------------------------------------------------------------------------
;; display the Ollama buffer in same window
;; ----------------------------------------------------------------------------------

  (add-to-list 'display-buffer-alist
     '("^*Ollama*" display-buffer-same-window))


;; ----------------------------------------------------------------------------------
;; display the Gemini buffer in same window
;; ----------------------------------------------------------------------------------

  (add-to-list 'display-buffer-alist
               '("^*Gemini*" display-buffer-same-window))


;; ----------------------------------------------------------------------------------
;; gptel set org source blocks to use sh and not bash
;; ----------------------------------------------------------------------------------

  (defun my/gptel-fix-src-header (beg end)
    (save-excursion
      (goto-char beg)
      (while (re-search-forward "^#\\+begin_src bash" end t)
        (replace-match "#+begin_src sh"))))

(add-hook 'gptel-post-response-functions #'my/gptel-fix-src-header)


;; ----------------------------------------------------------------------------------
;; gptel-tools create file
;; ----------------------------------------------------------------------------------

    (gptel-make-tool
     :function (lambda (path filename content)
                 (let ((full-path (expand-file-name filename path)))
                   (with-temp-buffer
                     (insert content)
                     (write-file full-path))
                   (format "Created file %s in %s" filename path)))
     :name "create_file"
     :description "Create a new file with the specified content"
     :args (list '(:name "path"
                   :type string
                   :description "The directory where to create the file")
                 '(:name "filename"
                   :type string
                   :description "The name of the file to create")
                 '(:name "content"
                   :type string
                   :description "The content to write to the file"))
     :category "filesystem")


;; ----------------------------------------------------------------------------------
;; gptel-tools read file
;; ----------------------------------------------------------------------------------

  (gptel-make-tool
   :function (lambda (filepath)
               (with-temp-buffer
                 (insert-file-contents (expand-file-name filepath))
                 (buffer-string)))
   :name "read_file"
   :description "Read and display the contents of a file"
   :args (list '(:name "filepath"
                 :type string
                 :description "Path to the file to read. Supports relative paths and ~."))
   :category "filesystem")


;; ----------------------------------------------------------------------------------
;; gptel-tools edit file
;; ----------------------------------------------------------------------------------

  (defun my-gptel--edit_file (file-path file-edits)
    "In FILE-PATH, apply FILE-EDITS with pattern matching and replacing."
    (if (and file-path (not (string= file-path "")) file-edits)
        (with-current-buffer (get-buffer-create "*edit-file*")
          (erase-buffer)
          (insert-file-contents (expand-file-name file-path))
          (let ((inhibit-read-only t)
                (case-fold-search nil)
                (file-name (expand-file-name file-path))
                (edit-success nil))
            ;; apply changes
            (dolist (file-edit (seq-into file-edits 'list))
              (when-let ((line-number (plist-get file-edit :line_number))
                         (old-string (plist-get file-edit :old_string))
                         (new-string (plist-get file-edit :new_string))
                         (is-valid-old-string (not (string= old-string ""))))
                (goto-char (point-min))
                (forward-line (1- line-number))
                (when (search-forward old-string nil t)
                  (replace-match new-string t t)
                  (setq edit-success t))))
            ;; return result to gptel
            (if edit-success
                (progn
                  ;; show diffs
                  (ediff-buffers (find-file-noselect file-name) (current-buffer))
                  (format "Successfully edited %s" file-name))
              (format "Failed to edited %s" file-name))))
      (format "Failed to edited %s" file-path)))
  
  (gptel-make-tool
     :function #'my-gptel--edit_file
     :name "edit_file"
     :description "Edit file with a list of edits, each edit contains a line-number,
  a old-string and a new-string, new-string will replace the old-string at the specified line."
     :args (list '(:name "file-path"
                         :type string
                         :description "The full path of the file to edit")
                 '(:name "file-edits"
                         :type array
                         :items (:type object
                                       :properties
                                       (:line_number
                                        (:type integer :description "The line number of the file where edit starts.")
                                        :old_string
                                        (:type string :description "The old-string to be replaced.")
                                        :new_string
                                        (:type string :description "The new-string to replace old-string.")))
                         :description "The list of edits to apply on the file"))
     :category "filesystem")


;; ----------------------------------------------------------------------------------
;; gptel-tools read buffer
;; ----------------------------------------------------------------------------------

    (gptel-make-tool
     :function (lambda (buffer)
                 (unless (buffer-live-p (get-buffer buffer))
                   (error "Error: buffer %s is not live." buffer))
                 (with-current-buffer buffer
                   (buffer-substring-no-properties (point-min) (point-max))))
     :name "read_buffer"
     :description "Return the contents of an Emacs buffer"
     :args (list '(:name "buffer"
                   :type string
                   :description "The name of the buffer whose contents are to be retrieved"))
     :category "emacs")


;; ----------------------------------------------------------------------------------
;; gptel-tools: Emacs Introspection (Derived from emacs-mcp.el source)
;; https://github.com/mpontus/emacs-mcp
;; ----------------------------------------------------------------------------------


;; ----------------------------------------------------------------------------------
;; Emacs: get_docstring
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (function-name)
             (let* ((symbol (intern-soft function-name))
                    (docstring (and symbol (documentation symbol))))
               (or docstring
                   (error "No docstring found for function: %s" function-name))))
 :name "get_docstring"
 :description "Get the docstring for an Emacs Lisp function.
Provides the raw documentation string for any Emacs Lisp function.
FUNCTION-NAME should be the name of the function as a string.
Returns the full docstring or an error if the function doesn't exist."
 :args (list '(:name "function-name" :type string :description "The name of the function as a string."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_elisp_variable
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (variable-name)
             (save-window-excursion
               (describe-variable (intern variable-name))
               (with-current-buffer "*Help*"
                 (let ((docstring (buffer-string)))
                   (kill-buffer)
                   docstring))))
 :name "describe_elisp_variable"
 :description "Describe an Emacs Lisp variable in detail.
Provides comprehensive information about a variable including:
- Current value
- Documentation string
- Whether it is customizable
- Where it was defined
VARIABLE-NAME should be the name of the variable as a string."
 :args (list '(:name "variable-name" :type string :description "The name of the variable as a string."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_key_binding
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (key-sequence)
             (save-window-excursion
               (let ((key (kbd key-sequence)))
                 (describe-key key)
                 (with-current-buffer "*Help*"
                   (let ((result (buffer-string)))
                     (kill-buffer)
                     result)))))
 :name "describe_key_binding"
 :description "Display documentation of the function invoked by KEY-SEQUENCE.
Provides information about what command a key sequence runs and its documentation.
KEY-SEQUENCE should be in Emacs key notation as a string (e.g. \"C-x C-f\").
Returns details about the key binding and the function it calls."
 :args (list '(:name "key-sequence" :type string :description "Key sequence in Emacs notation (e.g. \"C-x C-f\")."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_current_mode
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (save-window-excursion
               (describe-mode)
               (with-current-buffer "*Help*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "describe_current_mode"
 :description "Display documentation of current major mode and minor modes.
Provides comprehensive information about:
- The current major mode and its purpose
- All enabled minor modes
- Key bindings specific to these modes
This helps understand the current editing environment and available commands."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_elisp_function 
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (function-name)
             (save-window-excursion
               (describe-function (intern function-name))
               (with-current-buffer "*Help*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "describe_elisp_function"
 :description "Display the full documentation of FUNCTION.
Provides detailed information about an Emacs Lisp function including:
- Its argument list
- Full documentation string
- Where it was defined
- Key bindings that call this function
FUNCTION-NAME should be the name of the function as a string."
 :args (list '(:name "function-name" :type string :description "The name of the function as a string."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_display_face
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (face-name)
             (save-window-excursion
               (describe-face (intern face-name))
               (with-current-buffer "*Help*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "describe_display_face"
 :description "Display the properties of face FACE.
Provides detailed information about a display face including:
- Its appearance attributes (color, weight, slant, etc.)
- Where it was defined
- How it's currently displayed
FACE-NAME should be the name of the face as a string.
This is useful for understanding text styling in Emacs."
 :args (list '(:name "face-name" :type string :description "The name of the face as a string (e.g., 'default')."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_installed_package
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (package-name)
             (save-window-excursion
               (require 'package)
               (describe-package (intern package-name))
               (with-current-buffer "*Help*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "describe_installed_package"
 :description "Display the full documentation of PACKAGE.
Provides comprehensive information about an installed package including:
- Version information
- Summary and description
- Dependencies
- Features provided
PACKAGE-NAME should be the name of the package as a string.
This helps understand what functionality a package provides."
 :args (list '(:name "package-name" :type string :description "The name of the package as a string."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: list_all_bindings
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (save-window-excursion
               (describe-bindings)
               (with-current-buffer "*Help*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "list_all_bindings"
 :description "Display a buffer showing a list of all defined keys, and their definitions.
Provides a comprehensive list of all currently active key bindings organized by prefix.
This gives a complete overview of available commands and their key shortcuts.
Useful for understanding what commands are available in the current context."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_custom_theme
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (theme-name)
             (save-window-excursion
               (require 'custom)
               (describe-theme (intern theme-name))
               (with-current-buffer "*Help*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "describe_custom_theme"
 :description "Display a description of the Custom theme THEME.
Provides information about a specific Emacs theme including:
- Its settings and customizations
- Faces it defines or modifies
- Where it was defined
THEME-NAME should be the name of the theme as a string.
This helps understand how a theme affects Emacs appearance."
 :args (list '(:name "theme-name" :type string :description "The name of the theme as a string."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_current_syntax
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (save-window-excursion
               (describe-syntax)
               (with-current-buffer "*Help*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "describe_current_syntax"
 :description "Describe the syntax specifications in the current syntax table.
Provides detailed information about how Emacs interprets different characters
in the current buffer's major mode. This includes:
- Which characters are considered word constituents
- Which characters are considered punctuation
- How comment and string delimiters are defined
This is useful for understanding how Emacs parses text in different modes."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: apropos_command
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (pattern)
             (require 'apropos)
             (save-window-excursion
               (apropos-command pattern)
               (with-current-buffer "*Apropos*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "apropos_command"
 :description "Search for commands matching PATTERN.
Finds and returns information about all Emacs commands whose names match PATTERN.
PATTERN can be a regular expression or a simple string.
Results include command names, key bindings, and brief descriptions.
This is useful for discovering commands related to a specific topic or feature."
 :args (list '(:name "pattern" :type string :description "A string or regular expression to match command names."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: apropos_variable
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (pattern)
             (require 'apropos)
             (save-window-excursion
               (apropos-variable pattern)
               (with-current-buffer "*Apropos*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "apropos_variable"
 :description "Search for variables matching PATTERN.
Finds and returns information about all Emacs variables whose names match PATTERN.
PATTERN can be a regular expression or a simple string.
Results include variable names, current values, and brief descriptions.
This is useful for discovering configuration options related to a specific feature."
 :args (list '(:name "pattern" :type string :description "A string or regular expression to match variable names."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: apropos_value
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (pattern)
             (require 'apropos)
             (save-window-excursion
               (apropos-value pattern)
               (with-current-buffer "*Apropos*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "apropos_value"
 :description "Search for variables with values matching PATTERN.
Finds and returns information about Emacs variables whose values match PATTERN.
PATTERN can be a regular expression or a simple string.
Results include variable names, matching values, and brief descriptions.
This is useful for finding variables set to specific values or containing certain data."
 :args (list '(:name "pattern" :type string :description "A string or regular expression to match variable values."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: apropos_documentation
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (pattern)
             (require 'apropos)
             (save-window-excursion
               (apropos-documentation pattern)
               (with-current-buffer "*Apropos*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "apropos_documentation"
 :description "Search for symbols with documentation matching PATTERN.
Finds and returns information about Emacs symbols whose documentation contains PATTERN.
PATTERN can be a regular expression or a simple string.
Results include symbol names and the matching portions of their documentation.
This is useful for finding features described with specific terms in their documentation."
 :args (list '(:name "pattern" :type string :description "A string or regular expression to search within documentation strings."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: apropos_all_symbols
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (pattern)
             (require 'apropos)
             (save-window-excursion
               (apropos pattern)
               (with-current-buffer "*Apropos*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "apropos_all_symbols"
 :description "Search for symbols whose names match PATTERN.
Finds and returns information about all Emacs symbols whose names match PATTERN.
PATTERN can be a regular expression or a simple string.
Results include functions, variables, faces, and other symbols.
This is the most general search tool and useful for broad exploration of Emacs features."
 :args (list '(:name "pattern" :type string :description "A string or regular expression to match symbol names."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: info_get_node
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (node-name)
             (require 'info)
             (save-window-excursion
               (info node-name)
               (with-current-buffer "*info*"
                 (let ((result (buffer-string)))
                   (kill-buffer)
                   result))))
 :name "info_get_node"
 :description "Display the contents of an Info node.
Provides the full text content of a specific Info documentation node.
NODE-NAME should be the name of the node as a string (e.g. \"(emacs)Basic\").
Returns the text content of the specified Info node."
 :args (list '(:name "node-name" :type string :description "The Info node name as a string."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: info_documentation_search
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (topic)
             (require 'info)
             (save-window-excursion
               (info)
               (Info-search topic)
               (let ((result (format "Search results for '%s':\n\n" topic))
                     (node-name (format "%s" Info-current-node))
                     (file-name (format "%s" Info-current-file)))
                 (setq result (concat result
                                      (format "Found in node: %s in file: %s\n\n"
                                              node-name file-name)))
                 ;; Get context around the match
                 (let ((start (max (point-min) (- (point) 200)))
                       (end (min (point-max) (+ (point) 500))))
                   (setq result (concat result
                                        (buffer-substring-no-properties start end))))
                 (kill-buffer)
                 result)))
 :name "info_documentation_search"
 :description "Search for TOPIC in the Info documentation.
Performs a search across Info documentation for the specified topic.
TOPIC should be a string to search for.
Returns a list of matching nodes and context around the matches."
 :args (list '(:name "topic" :type string :description "The topic string to search for."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: info_index_lookup
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (index-item)
             (require 'info)
             (save-window-excursion
               (info)
               (Info-index index-item)
               (with-current-buffer "*info*"
                 (let ((result (format "Index results for '%s':\n\n" index-item))
                       (node-name (format "%s" Info-current-node))
                       (file-name (format "%s" Info-current-file)))
                   (setq result (concat result
                                        (format "Found in node: %s in file: %s\n\n"
                                                node-name file-name)))
                   ;; Get the content of the node
                   (setq result (concat result (buffer-substring-no-properties (point-min) (point-max))))
                   (kill-buffer)
                   result))))
 :name "info_index_lookup"
 :description "Look up INDEX-ITEM in the indices of the Info documentation.
Finds entries in Info documentation indices that match the specified item.
INDEX-ITEM should be a string to look up in the indices.
Returns information about matching index entries and their locations."
 :args (list '(:name "index-item" :type string :description "The item string to look up in the indices."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: info_get_toc
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (manual)
             (require 'info)
             (save-window-excursion
               (info (concat "(" manual ")"))
               (Info-directory)
               (with-current-buffer "*info*"
                 (let ((result (format "Table of Contents for '%s':\n\n" manual)))
                   (setq result (concat result (buffer-substring-no-properties (point-min) (point-max))))
                   (kill-buffer)
                   result))))
 :name "info_get_toc"
 :description "Display the table of contents for a specific Info MANUAL.
Provides the structure and organization of an Info manual.
MANUAL should be the name of the manual as a string (e.g. \"emacs\").
Returns the table of contents of the specified manual."
 :args (list '(:name "manual" :type string :description "The name of the Info manual as a string."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: info_list_manuals
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (require 'info)
             (save-window-excursion
               (info)
               (Info-directory)
               (with-current-buffer "*info*"
                 (let ((result "Available Info Manuals:\n\n"))
                   (setq result (concat result (buffer-substring-no-properties (point-min) (point-max))))
                   (kill-buffer)
                   result))))
 :name "info_list_manuals"
 :description "List all available Info manuals.
Provides a comprehensive list of all Info documentation manuals available in the system.
This helps discover what documentation is available for reference."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: get_emacs_version
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (concat "Emacs Version:\n\n" (emacs-version)))
 :name "get_emacs_version"
 :description "Get detailed information about the current Emacs version.
Provides version number, build details, and system configuration information.
This helps understand the capabilities and limitations of the current Emacs instance."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: list_loaded_features
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (let ((result "Loaded Features:\n\n"))
               (dolist (feature features)
                 (setq result (concat result (format "- %s\n" feature))))
               result))
 :name "list_loaded_features"
 :description "List all features (libraries) that have been loaded in Emacs.
Provides a comprehensive list of all Emacs Lisp libraries currently loaded.
This helps understand what functionality is available in the current session."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: list_installed_packages
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (require 'package)
             (package-initialize)
             (let ((result "Installed Packages:\n\n"))
               (dolist (pkg package-alist)
                 (let* ((name (car pkg))
                        (desc (cadr pkg))
                        (version (package-desc-version desc))
                        (status (if (package-installed-p name) "Installed" "Not Installed")))
                   (setq result (concat result (format "- %s (%s): %s\n"
                                                      name version status)))))
               result))
 :name "list_installed_packages"
 :description "List all installed packages with their status and version.
Provides a comprehensive overview of the user's package ecosystem."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: list_available_modes
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (let ((result "Available Major Modes:\n\n")
                   (modes '()))
               (mapatoms (lambda (sym)
                           (when (and (functionp sym)
                                      (string-match "-mode$" (symbol-name sym))
                                      (not (string-match "-minor-mode$" (symbol-name sym))))
                             (push (symbol-name sym) modes))))
               (setq modes (sort modes 'string<))
               (dolist (mode modes)
                 (setq result (concat result (format "- %s\n" mode))))
               result))
 :name "list_available_modes"
 :description "List all available major modes in this Emacs instance.
Provides a comprehensive list of all major modes that can be used.
This helps understand what file types and editing modes are supported."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: list_custom_variables
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (require 'cus-edit)
             (let ((result "Customized Variables:\n\n"))
               (dolist (theme custom-enabled-themes)
                 (setq result (concat result (format "Theme: %s\n" theme))))
               (setq result (concat result "\nVariables:\n"))
               (mapatoms
                (lambda (symbol)
                  (when (and (boundp symbol)
                             (get symbol 'saved-value))
                    (setq result (concat result (format "- %s: %S\n"
                                                      symbol (symbol-value symbol)))))))
               result))
 :name "list_custom_variables"
 :description "List all customized variables in the current Emacs session.
Shows variables that have been customized away from their default values.
This helps understand how the user has personalized their Emacs."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: describe_matching_hooks
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (hook-pattern)
             (let ((result (format "Hooks matching \"%s\":\n\n" hook-pattern))
                   (hooks '()))
               (mapatoms
                (lambda (symbol)
                  (when (and (boundp symbol)
                             (string-match "-hook$" (symbol-name symbol))
                             (string-match hook-pattern (symbol-name symbol)))
                    (push symbol hooks))))
               (setq hooks (sort hooks (lambda (a b) (string< (symbol-name a) (symbol-name b)))))
               (dolist (hook hooks)
                 (setq result (concat result (format "- %s:\n" hook)))
                 (let ((value (symbol-value hook)))
                   (if (not value)
                       (setq result (concat result "  (empty)\n"))
                     (dolist (func value)
                       (setq result (concat result (format "  - %s\n" func)))))))
               result))
 :name "describe_matching_hooks"
 :description "List and show the functions attached to hooks matching HOOK-PATTERN."
 :args (list '(:name "hook-pattern" :type string :description "A string or regex to match hook names (e.g., 'prog-mode')."))
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: list_available_fonts
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda ()
             (let ((result "Available Fonts:\n\n")
                   (fonts (font-family-list)))
               (setq fonts (sort fonts 'string<))
               (dolist (font fonts)
                 (setq result (concat result (format "- %s\n" font))))
               result))
 :name "list_available_fonts"
 :description "List all available fonts in the current Emacs session.
Shows what fonts can be used for display customization.
This helps understand display capabilities and options."
 :args nil
 :category "emacs")


;; ----------------------------------------------------------------------------------
;; Emacs: find_key_conflicts
;; ----------------------------------------------------------------------------------

(gptel-make-tool
 :function (lambda (prefix)
             (require 'help-fns)
             (let ((result (format "Key bindings starting with %s:\n\n" prefix))
                   (key (kbd prefix))
                   (map (current-global-map))
                   bindings)
               ;; This code block has a minor issue in the original file,
               ;; as it attempts to call lookup-key on a keymap which is not a vector.
               ;; The intention is to list all keys *under* the prefix, but since 
               ;; the exact logic is hard to reproduce reliably outside the package,
               ;; we simplify it to list all bindings that START with the prefix.
               (map-keymap
                (lambda (k v)
                  (when (and v (string-prefix-p prefix (key-description (vector k))))
                    (let ((key-desc (key-description (vector k))))
                      (push (cons key-desc v) bindings))))
                map)
               (setq bindings (sort bindings (lambda (a b) (string< (car a) (car b)))))
               (dolist (binding bindings)
                 (setq result (concat result (format "- %s: %s\n"
                                                    (car binding)
                                                    (cdr binding)))))
               result))
 :name "find_key_conflicts"
 :description "Find conflicting key bindings starting with PREFIX.
Identifies key sequences that might shadow or conflict with each other.
PREFIX should be a key prefix in string form (e.g. \"C-c\").
This helps diagnose keybinding issues and conflicts."
 :args (list '(:name "prefix" :type string :description "The key prefix string to check (e.g. \"C-c\")."))
 :category "emacs")


  ) ;; gptel use-package config closing parentheses
;; ----------------------------------------------------------------------------------



;; ----------------------------------------------------------------------------------
;; mcp server
;; ----------------------------------------------------------------------------------

(use-package mcp
  :after gptel
  :custom
  (mcp-hub-servers `(("mcp-nixos" . (
                                      :command "podman" ; <-- Use your container runtime
                                      :args ("run" "--rm" "-i" "ghcr.io/utensils/mcp-nixos")))
                     ("searxng" . ( ; General web search tool
                                    :command "podman"
                                    :args ("run" "-i" "--rm"
                                           "--network=host"
                                            "-e" "SEARXNG_URL=http://localhost:8080"
                                            "mcp-searxng:local")
                                    ))
                     )) ;; closing parentheses

  :config
  (require 'mcp-hub))
#+end_src

** authinfo

[[https://aistudio.google.com/app/apikey]]

#+begin_src 
vi ~/.config/emacs/.authinfo
#+end_src

#+begin_src conf
machine generativelanguage.googleapis.com password token
#+end_src
